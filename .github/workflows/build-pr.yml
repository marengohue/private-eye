name: Build and Test (Pull Request)

on:
  pull_request:
    paths:
      - src/**
      - .github/**

env:
  PACKAGE_VERSION: ${{ vars.PACKAGE_VERSION }}

jobs:
  build_and_test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build
        run: dotnet build --configuration=Debug

      - name: Test
        run: dotnet test

      - name: Determine Build Version
        id: determine_version
        run: |
          RUN_ID=${{ github.run_id }}
          echo "run_id: $(RUN_ID)"
          RUN_NO=${{ github.run_number }}
          echo "run_no: $(RUN_NO)"
          BUILD_VERSION="$(PACKAGE_VERSION).$(RUN_ID)$(RUN_NO)-alpha"
          echo "build_ver: $(BUILD_VERSION)"
          echo "build_version = $(BUILD_VERSION)" >> $GITHUB_ENV

      - name: Pack NuGet Packages
        run: |
          mkdir -p .publish
          dotnet pack \
              --output .publish \
              --include-source \
              /p:Version="${{ steps.determine_version.outputs.build_version }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: nuget
          path: .publish/*.nupkg
          retention-days: 5
